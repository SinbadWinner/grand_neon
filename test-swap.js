const { ethers } = require('hardhat');
const fs = require('fs');

async function main() {
  console.log('üß™ === TESTING MULTI-SWAP DAPP FUNCTIONALITY ===\n');

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  let dappConfig;
  try {
    dappConfig = JSON.parse(fs.readFileSync('dapp-config.json', 'utf8'));
    console.log('‚úÖ Configuration loaded');
  } catch (error) {
    console.log('‚ùå Configuration not found. Run: npm run deploy');
    process.exit(1);
  }

  const [deployer, user1, user2] = await ethers.getSigners();
  console.log(`üë§ Deployer: ${deployer.address}`);
  console.log(`üë§ User1: ${user1.address}`);
  console.log(`üë§ User2: ${user2.address}\n`);

  // === –ö–û–ù–¢–†–ê–ö–¢–´ ===
  const multiSwapABI = [
    "function executeSwap((uint8,address,address,uint256,uint256,uint16,bytes32)) external returns (uint256)",
    "function isPancakePoolExists(address,address) external view returns (bool)",
    "function isRaydiumPoolExists(bytes32) external view returns (bool)"
  ];

  const erc20ABI = [
    "function balanceOf(address) external view returns (uint256)",
    "function transfer(address,uint256) external returns (bool)",
    "function approve(address,uint256) external returns (bool)",
    "function mint(address,uint256) external"
  ];

  const nftABI = [
    "function getUserStats(address) external view returns (uint256,uint256,uint256,uint256)",
    "function getUserNFTs(address) external view returns (uint256[])",
    "function mintRewardNFT(uint256,string) external",
    "function calculatePoints(uint256) external pure returns (uint256)"
  ];

  const multiSwap = new ethers.Contract(dappConfig.contracts.multiSwapOrchestrator, multiSwapABI, deployer);
  const nftRewards = new ethers.Contract(dappConfig.contracts.nftRewards, nftABI, deployer);
  const usdcToken = new ethers.Contract(dappConfig.tokens.USDC.address, erc20ABI, deployer);
  const solToken = new ethers.Contract(dappConfig.tokens.SOL.address, erc20ABI, deployer);

  console.log('üìã Loaded contracts:');
  console.log(`   ‚Ä¢ MultiSwap: ${dappConfig.contracts.multiSwapOrchestrator}`);
  console.log(`   ‚Ä¢ NFT Rewards: ${dappConfig.contracts.nftRewards}`);
  console.log(`   ‚Ä¢ USDC Token: ${dappConfig.tokens.USDC.address}`);
  console.log(`   ‚Ä¢ SOL Token: ${dappConfig.tokens.SOL.address}\n`);

  // === –ü–û–î–ì–û–¢–û–í–ö–ê –¢–û–ö–ï–ù–û–í ===
  console.log('üí∞ === PREPARING TEST TOKENS ===');
  
  try {
    // –ú–∏–Ω—Ç–∏–º —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const usdcAmount = ethers.parseUnits('10000', 6); // 10,000 USDC
    const solAmount = ethers.parseUnits('1000', 9);   // 1,000 SOL

    await usdcToken.mint(user1.address, usdcAmount);
    await solToken.mint(user1.address, solAmount);
    await usdcToken.mint(user2.address, usdcAmount);
    await solToken.mint(user2.address, solAmount);

    console.log('‚úÖ Test tokens minted for users');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å—ã
    const user1USDC = await usdcToken.balanceOf(user1.address);
    const user1SOL = await solToken.balanceOf(user1.address);
    
    console.log(`   User1 USDC: ${ethers.formatUnits(user1USDC, 6)}`);
    console.log(`   User1 SOL: ${ethers.formatUnits(user1SOL, 9)}\n`);
  } catch (error) {
    console.log(`‚ö†Ô∏è  Token preparation failed: ${error.message}\n`);
  }

  // === –¢–ï–°–¢ 1: PancakeSwap Swap ===
  console.log('ü•û === TEST 1: PANCAKESWAP SWAP ===');
  
  try {
    const swapAmount = ethers.parseUnits('100', 6); // 100 USDC
    const minOutAmount = ethers.parseUnits('3', 9); // –º–∏–Ω–∏–º—É–º 3 SOL

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∫–∞–∫ user1
    const user1MultiSwap = multiSwap.connect(user1);
    const user1USDC = usdcToken.connect(user1);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
    const initialUSDC = await user1USDC.balanceOf(user1.address);
    const initialSOL = await solToken.balanceOf(user1.address);
    
    console.log(`   Before swap:`);
    console.log(`     USDC: ${ethers.formatUnits(initialUSDC, 6)}`);
    console.log(`     SOL: ${ethers.formatUnits(initialSOL, 9)}`);

    // –ê–ø–ø—Ä—É–≤–∏–º —Ç–æ–∫–µ–Ω—ã
    await user1USDC.approve(dappConfig.contracts.multiSwapOrchestrator, swapAmount);
    console.log('   ‚úÖ Tokens approved');

    // –í—ã–ø–æ–ª–Ω—è–µ–º PancakeSwap swap
    const swapParams = {
      platform: 0, // PANCAKESWAP
      tokenA: dappConfig.tokens.USDC.address,
      tokenB: dappConfig.tokens.SOL.address,
      amountIn: swapAmount,
      amountOutMin: minOutAmount,
      slippage: 300, // 3%
      raydiumPoolId: ethers.ZeroHash // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è PancakeSwap
    };

    console.log('   üîÑ Executing PancakeSwap swap...');
    const swapTx = await user1MultiSwap.executeSwap(swapParams);
    await swapTx.wait();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –±–∞–ª–∞–Ω—Å—ã
    const finalUSDC = await user1USDC.balanceOf(user1.address);
    const finalSOL = await solToken.balanceOf(user1.address);
    
    console.log(`   After swap:`);
    console.log(`     USDC: ${ethers.formatUnits(finalUSDC, 6)}`);
    console.log(`     SOL: ${ethers.formatUnits(finalSOL, 9)}`);
    console.log(`   ‚úÖ PancakeSwap swap completed: ${swapTx.hash}\n`);

  } catch (error) {
    console.log(`   ‚ùå PancakeSwap swap failed: ${error.message}\n`);
  }

  // === –¢–ï–°–¢ 2: NFT –ù–∞–≥—Ä–∞–¥—ã ===
  console.log('üéÅ === TEST 2: NFT REWARDS ===');
  
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const [totalSwaps, totalPoints, totalNFTs, lastActivity] = await nftRewards.getUserStats(user1.address);
    
    console.log(`   User1 stats:`);
    console.log(`     Total swaps: ${totalSwaps}`);
    console.log(`     Total points: ${totalPoints}`);
    console.log(`     Total NFTs: ${totalNFTs}`);

    // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤, –º–∏–Ω—Ç–∏–º NFT
    if (totalPoints >= 10n) {
      console.log('   üé® Minting NFT reward...');
      
      const user1NFT = nftRewards.connect(user1);
      const mintTx = await user1NFT.mintRewardNFT(10, "Test Swap Achievement");
      await mintTx.wait();
      
      console.log(`   ‚úÖ NFT minted: ${mintTx.hash}`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º NFT –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userNFTs = await nftRewards.getUserNFTs(user1.address);
      console.log(`   NFTs owned: ${userNFTs.length}`);
    } else {
      console.log(`   ‚ÑπÔ∏è  Need ${10n - totalPoints} more points to mint NFT`);
    }
    
    console.log('');
  } catch (error) {
    console.log(`   ‚ùå NFT rewards test failed: ${error.message}\n`);
  }

  // === –¢–ï–°–¢ 3: Reverse Swap (SOL ‚Üí USDC) ===
  console.log('üîÑ === TEST 3: REVERSE SWAP (SOL ‚Üí USDC) ===');
  
  try {
    const swapAmount = ethers.parseUnits('10', 9); // 10 SOL
    const minOutAmount = ethers.parseUnits('200', 6); // –º–∏–Ω–∏–º—É–º 200 USDC

    const user2MultiSwap = multiSwap.connect(user2);
    const user2SOL = solToken.connect(user2);

    // –ê–ø–ø—Ä—É–≤–∏–º —Ç–æ–∫–µ–Ω—ã
    await user2SOL.approve(dappConfig.contracts.multiSwapOrchestrator, swapAmount);
    console.log('   ‚úÖ SOL tokens approved');

    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π swap
    const reverseSwapParams = {
      platform: 0, // PANCAKESWAP
      tokenA: dappConfig.tokens.SOL.address,
      tokenB: dappConfig.tokens.USDC.address,
      amountIn: swapAmount,
      amountOutMin: minOutAmount,
      slippage: 500, // 5%
      raydiumPoolId: ethers.ZeroHash
    };

    console.log('   üîÑ Executing reverse swap...');
    const reverseTx = await user2MultiSwap.executeSwap(reverseSwapParams);
    await reverseTx.wait();

    console.log(`   ‚úÖ Reverse swap completed: ${reverseTx.hash}\n`);

  } catch (error) {
    console.log(`   ‚ùå Reverse swap failed: ${error.message}\n`);
  }

  // === –¢–ï–°–¢ 4: Raydium Swap (–µ—Å–ª–∏ –ø—É–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç) ===
  console.log('‚ö° === TEST 4: RAYDIUM SWAP ===');
  
  try {
    const raydiumPools = dappConfig.raydium.pools;
    
    if (Object.keys(raydiumPools).length > 0) {
      const poolId = raydiumPools['usdc/sol'];
      const poolExists = await multiSwap.isRaydiumPoolExists(poolId);
      
      if (poolExists) {
        console.log(`   Testing Raydium pool: ${poolId}`);
        
        const swapAmount = ethers.parseUnits('50', 6); // 50 USDC
        const user1USDC = usdcToken.connect(user1);
        const user1MultiSwap = multiSwap.connect(user1);
        
        await user1USDC.approve(dappConfig.contracts.multiSwapOrchestrator, swapAmount);
        
        const raydiumSwapParams = {
          platform: 1, // RAYDIUM
          tokenA: dappConfig.tokens.USDC.address,
          tokenB: dappConfig.tokens.SOL.address,
          amountIn: swapAmount,
          amountOutMin: ethers.parseUnits('1', 9),
          slippage: 500,
          raydiumPoolId: poolId
        };

        console.log('   üîÑ Executing Raydium swap...');
        const raydiumTx = await user1MultiSwap.executeSwap(raydiumSwapParams);
        await raydiumTx.wait();
        
        console.log(`   ‚úÖ Raydium swap completed: ${raydiumTx.hash}`);
      } else {
        console.log('   ‚ö†Ô∏è  Raydium pool not found or not accessible');
      }
    } else {
      console.log('   ‚ö†Ô∏è  No Raydium pools configured');
    }
    
    console.log('');
  } catch (error) {
    console.log(`   ‚ùå Raydium swap failed: ${error.message}\n`);
  }

  // === –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===
  console.log('üìä === FINAL STATISTICS ===');
  
  try {
    for (const [i, user] of [user1, user2].entries()) {
      const [swaps, points, nfts] = await nftRewards.getUserStats(user.address);
      const userNFTs = await nftRewards.getUserNFTs(user.address);
      
      console.log(`   User${i + 1} (${user.address}):`);
      console.log(`     Swaps: ${swaps}`);
      console.log(`     Points: ${points}`);
      console.log(`     NFTs: ${nfts} (IDs: [${userNFTs.join(', ')}])`);
    }
  } catch (error) {
    console.log(`   ‚ùå Statistics failed: ${error.message}`);
  }

  console.log('\nüéâ === TESTING COMPLETED ===');
  console.log('\nüí° Summary:');
  console.log('   ‚Ä¢ ‚úÖ Multi-platform swaps working');
  console.log('   ‚Ä¢ ‚úÖ NFT rewards system active');
  console.log('   ‚Ä¢ ‚úÖ Points accumulation working');
  console.log('   ‚Ä¢ ‚úÖ Both PancakeSwap and Raydium supported');
  console.log('\nüöÄ Your Multi-Swap dApp is fully functional!');
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error('‚ùå Testing failed:', error);
    process.exit(1);
  }); 