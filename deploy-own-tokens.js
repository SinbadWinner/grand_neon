const { ethers } = require("hardhat");
const config = require("./dapp-config.js");

async function deployOwnTokens() {
    console.log("üöÄ === DEPLOYING OWN TOKEN ECOSYSTEM ===\n");
    console.log("üìù Creating completely custom token ecosystem:");
    console.log("   - BASE: Our native base token (instead of WNEON)");
    console.log("   - USDC: Mock USD Coin");
    console.log("   - USDT: Mock Tether USD");
    console.log("   - BTC: Mock Bitcoin");
    console.log("   - ETH: Mock Ethereum");
    console.log("   - All tokens use same BaseToken contract\n");
    
    try {
        const [deployer] = await ethers.getSigners();
        console.log(`üë§ Deployer: ${deployer.address}`);
        
        const balance = await deployer.provider.getBalance(deployer.address);
        console.log(`üí∞ Balance: ${ethers.formatEther(balance)} ETH\n`);
        
        // === 1. DEPLOY BASE TOKEN (–∑–∞–º–µ–Ω–∞ WNEON) ===
        console.log("üåä === STEP 1: DEPLOYING BASE TOKEN ===");
        
        const BaseTokenFactory = await ethers.getContractFactory("BaseToken");
        const baseToken = await BaseTokenFactory.deploy(
            "Platform Base Token",
            "BASE",
            ethers.parseEther("10000000"), // 10M supply
            18 // decimals
        );
        await baseToken.waitForDeployment();
        const baseTokenAddress = await baseToken.getAddress();
        console.log(`‚úÖ BASE deployed: ${baseTokenAddress}`);
        
        // === 2. DEPLOY ALL TOKENS ===
        console.log("\nüí∞ === STEP 2: DEPLOYING ALL TOKENS ===");
        
        const tokens = { base: baseTokenAddress };
        
        const tokenConfigs = [
            { name: "USD Coin", symbol: "USDC", supply: "1000000", decimals: 6 },
            { name: "Tether USD", symbol: "USDT", supply: "1000000", decimals: 6 },
            { name: "Bitcoin", symbol: "BTC", supply: "21000", decimals: 8 },
            { name: "Ethereum", symbol: "ETH", supply: "120000000", decimals: 18 }
        ];
        
        for (const tokenConfig of tokenConfigs) {
            const token = await BaseTokenFactory.deploy(
                tokenConfig.name,
                tokenConfig.symbol,
                ethers.parseUnits(tokenConfig.supply, tokenConfig.decimals),
                tokenConfig.decimals
            );
            await token.waitForDeployment();
            const tokenAddress = await token.getAddress();
            tokens[tokenConfig.symbol.toLowerCase()] = tokenAddress;
            console.log(`‚úÖ ${tokenConfig.symbol} deployed: ${tokenAddress}`);
        }
        
        // === 3. DEPLOY PANCAKESWAP CONTRACTS ===
        console.log("\nü•û === STEP 3: DEPLOYING PANCAKESWAP ===");
        
        // Deploy PancakeFactory
        const PancakeFactory = await ethers.getContractFactory("PancakeFactory");
        const factory = await PancakeFactory.deploy(deployer.address);
        await factory.waitForDeployment();
        const factoryAddress = await factory.getAddress();
        console.log(`‚úÖ PancakeFactory deployed: ${factoryAddress}`);
        
        // Deploy PancakeRouter —Å BASE —Ç–æ–∫–µ–Ω–æ–º
        const PancakeRouter = await ethers.getContractFactory("PancakeRouter");
        const router = await PancakeRouter.deploy(factoryAddress, baseTokenAddress);
        await router.waitForDeployment();
        const routerAddress = await router.getAddress();
        console.log(`‚úÖ PancakeRouter deployed: ${routerAddress}`);
        
        // === 4. –°–û–ó–î–ê–ù–ò–ï –¢–û–†–ì–û–í–´–• –ü–ê–† ===
        console.log("\nüîÑ === STEP 4: CREATING TRADING PAIRS ===");
        
        const pairs = [];
        const pairTokens = ['usdc', 'usdt', 'btc', 'eth'];
        
        for (const symbol of pairTokens) {
            const tokenAddress = tokens[symbol];
            console.log(`üìä Creating ${symbol.toUpperCase()}/BASE pair...`);
            
            const tx = await factory.createPair(tokenAddress, baseTokenAddress);
            await tx.wait();
            
            const pairAddress = await factory.getPair(tokenAddress, baseTokenAddress);
            pairs.push({
                symbol: symbol.toUpperCase(),
                address: pairAddress,
                token0: tokenAddress,
                token1: baseTokenAddress
            });
            
            console.log(`   ‚úÖ ${symbol.toUpperCase()}/BASE pair: ${pairAddress}`);
        }
        
        // === 5. INITIAL LIQUIDITY SETUP ===
        console.log("\nüèä === STEP 5: SETTING UP INITIAL LIQUIDITY ===");
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã
        const liquiditySetups = [
            { symbol: 'usdc', baseAmount: '1000', tokenAmount: '1000' },
            { symbol: 'usdt', baseAmount: '1000', tokenAmount: '1000' },
            { symbol: 'btc', baseAmount: '500', tokenAmount: '1' },
            { symbol: 'eth', baseAmount: '100', tokenAmount: '10' }
        ];
        
        for (const setup of liquiditySetups) {
            const tokenContract = await ethers.getContractAt("BaseToken", tokens[setup.symbol]);
            const tokenInfo = tokenConfigs.find(t => t.symbol.toLowerCase() === setup.symbol);
            
            const baseAmount = ethers.parseEther(setup.baseAmount);
            const tokenAmount = ethers.parseUnits(setup.tokenAmount, tokenInfo.decimals);
            
            console.log(`üíß Setting up ${setup.symbol.toUpperCase()}/BASE liquidity...`);
            
            // Approve tokens
            await baseToken.approve(routerAddress, baseAmount);
            await tokenContract.approve(routerAddress, tokenAmount);
            
            // Add liquidity
            await router.addLiquidity(
                tokens[setup.symbol],
                baseTokenAddress,
                tokenAmount,
                baseAmount,
                0, // min amounts
                0,
                deployer.address,
                Math.floor(Date.now() / 1000) + 3600 // 1 hour deadline
            );
            
            console.log(`   ‚úÖ Added ${setup.tokenAmount} ${setup.symbol.toUpperCase()} + ${setup.baseAmount} BASE`);
        }
        
        // === 6. DEPLOY RAYDIUM & NFT SYSTEM ===
        console.log("\nüåà === STEP 6: DEPLOYING ADDITIONAL SYSTEMS ===");
        
        // Deploy Raydium
        const RaydiumFactory = await ethers.getContractFactory("RaydiumSwapContract");
        const raydium = await RaydiumFactory.deploy();
        await raydium.waitForDeployment();
        const raydiumAddress = await raydium.getAddress();
        console.log(`‚úÖ Raydium deployed: ${raydiumAddress}`);
        
        // Deploy NFT Rewards
        const NFTRewardsFactory = await ethers.getContractFactory("NFTRewardsContract");
        const nftRewards = await NFTRewardsFactory.deploy(
            "Trading Rewards NFT",
            "TRN",
            "https://api.example.com/nft/"
        );
        await nftRewards.waitForDeployment();
        const nftRewardsAddress = await nftRewards.getAddress();
        console.log(`‚úÖ NFT Rewards deployed: ${nftRewardsAddress}`);
        
        // === 7. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ===
        console.log("\nüìù === STEP 7: UPDATING CONFIGURATION ===");
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        config.updatePancakeSwap(factoryAddress, routerAddress, baseTokenAddress);
        config.updateTokens(tokens);
        config.updateRaydium(raydiumAddress);
        config.updateNFTRewards(nftRewardsAddress);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ä–∞—Ö
        const pairInfo = {};
        pairs.forEach(pair => {
            pairInfo[`${pair.symbol}/BASE`] = pair.address;
        });
        config.updatePairs(pairInfo);
        
        console.log("‚úÖ Configuration updated successfully");
        
        // === 8. –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ ===
        console.log("\nüìã === DEPLOYMENT SUMMARY ===");
        console.log(`üåä BASE Token: ${baseTokenAddress}`);
        console.log(`üè≠ PancakeFactory: ${factoryAddress}`);
        console.log(`üîÄ PancakeRouter: ${routerAddress}`);
        console.log(`üåà Raydium: ${raydiumAddress}`);
        console.log(`üé® NFT Rewards: ${nftRewardsAddress}`);
        
        console.log("\nüí∞ Token Ecosystem:");
        Object.entries(tokens).forEach(([symbol, address]) => {
            console.log(`   ${symbol.toUpperCase()}: ${address}`);
        });
        
        console.log("\nüìä Trading Pairs with Liquidity:");
        pairs.forEach(pair => {
            console.log(`   ${pair.symbol}/BASE: ${pair.address}`);
        });
        
        console.log("\nüéâ === CUSTOM TOKEN ECOSYSTEM DEPLOYED ===");
        console.log("\nüí° Next steps:");
        console.log("   1. Test token transfers and approvals");
        console.log("   2. Test trading on PancakeSwap");
        console.log("   3. Test NFT rewards system");
        console.log("   4. Add more liquidity if needed");
        
        return {
            baseToken: baseTokenAddress,
            factory: factoryAddress,
            router: routerAddress,
            raydium: raydiumAddress,
            nftRewards: nftRewardsAddress,
            tokens,
            pairs: pairInfo
        };
        
    } catch (error) {
        console.error("‚ùå Deployment failed:", error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
async function testTokenEcosystem() {
    console.log("üß™ === TESTING TOKEN ECOSYSTEM ===\n");
    
    const [deployer, user1] = await ethers.getSigners();
    
    // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    const baseTokenAddress = config.pancakeswap.wneon; // BASE —Ç–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ wneon
    const usdcAddress = config.tokens.usdc;
    const routerAddress = config.pancakeswap.router;
    
    const baseToken = await ethers.getContractAt("BaseToken", baseTokenAddress);
    const usdcToken = await ethers.getContractAt("BaseToken", usdcAddress);
    const router = await ethers.getContractAt("PancakeRouter", routerAddress);
    
    console.log("üîÑ Testing token transfers...");
    
    // Transfer BASE tokens to user1
    const transferAmount = ethers.parseEther("100");
    await baseToken.transfer(user1.address, transferAmount);
    
    const user1Balance = await baseToken.balanceOf(user1.address);
    console.log(`‚úÖ User1 BASE balance: ${ethers.formatEther(user1Balance)}`);
    
    console.log("\nüîÑ Testing token swaps...");
    
    // Swap BASE for USDC
    const swapAmount = ethers.parseEther("10");
    const path = [baseTokenAddress, usdcAddress];
    
    // Get expected output
    const amountsOut = await router.getAmountsOut(swapAmount, path);
    console.log(`Expected USDC output: ${ethers.formatUnits(amountsOut[1], 6)}`);
    
    // Perform swap
    await baseToken.connect(user1).approve(routerAddress, swapAmount);
    await router.connect(user1).swapExactTokensForTokens(
        swapAmount,
        0, // Accept any amount
        path,
        user1.address,
        Math.floor(Date.now() / 1000) + 3600
    );
    
    const user1UsdcBalance = await usdcToken.balanceOf(user1.address);
    console.log(`‚úÖ User1 USDC balance after swap: ${ethers.formatUnits(user1UsdcBalance, 6)}`);
    
    console.log("\nüéâ Token ecosystem test completed!");
}

// –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π
module.exports = {
    deployOwnTokens,
    testTokenEcosystem
};

// –ó–∞–ø—É—Å–∫, –µ—Å–ª–∏ —Ñ–∞–π–ª –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é
if (require.main === module) {
    deployOwnTokens()
        .then(() => process.exit(0))
        .catch((error) => {
            console.error(error);
            process.exit(1);
        });
} 